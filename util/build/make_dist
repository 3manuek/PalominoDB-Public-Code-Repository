#!/usr/bin/env perl
use strict;
use warnings FATAL => 'all';
use English qw(-no_match_vars);
require 'insert_module';

my $input = "";
my $module_path = shift @ARGV;
my $infile = shift @ARGV;
my $outfile = shift @ARGV;
my @modules;

{
  open my $file, "<$infile";
  $/ = undef;
  $input = <$file>;
  close $file;
}

my $script_ver = qx@../../util/gitver.sh $infile@;

$input =~ s/\bSCRIPT_GIT_VERSION\b/$script_ver/g;
$input =~ s/\bGIT_SCRIPT_VERSION\b/$script_ver/g;

(@modules) = $input =~ /^# (\w+) package (?:[a-f0-9]{40}|GIT_VERSION)/mg;

foreach my $m (@modules) {
  $input = SrcUtils::insert_module($module_path, $m, $input);
}

open my $output, ">$outfile";
print $output $input;
close $output;
