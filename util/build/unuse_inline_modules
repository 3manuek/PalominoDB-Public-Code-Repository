#!/usr/bin/env perl
use strict;
use warnings;

use English qw(-no_match_vars);

my $inf = shift @ARGV;
my $outf = shift @ARGV;

my @input = undef;

open my $fh, "<", $inf
  or die $OS_ERROR;
  @input = <$fh>;

open $fh, '>', $outf
  or die $OS_ERROR;

my %modules = ();

foreach (@input) {
  if(/^# (\w+) package ([a-f0-9]{40}|GIT_VERSION)/) {
    $modules{$1} = 1;
  }
}

grep {
  foreach my $m (keys %modules) {
    if(/^use\s+$m/) {
      $_ = "";
    }
  }
} @input;

print $fh @input;

